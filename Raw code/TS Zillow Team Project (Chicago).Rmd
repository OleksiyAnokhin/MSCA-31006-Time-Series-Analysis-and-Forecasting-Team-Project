---
title: "TS Zillow Team Project"
author: "Oleksiy Anokhin"
date: "10/29/2020"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 5
---

<center>
![](Images/Zillow.png)
</center>

### Introduction

This project uses data from [Zillow](https://www.zillow.com/research/data/) - an American online real estate database company.

The company provides access to its data - in particular, `Median Sale Price` (which is available in monthly and weekly views).

Our analysis is focused on `Median Sale Price` - the median price at which homes across various geographies were sold.

### Packages

```{r, message = FALSE, warning = FALSE}
# Install packages
library(tidyverse) # for general analysis
library(fpp)
# library(fpp2)
library(fpp3) # for predictions 
# Important notice: the latest package here is fpp3, but it does not work well sometimes with 'ts' data. 
# https://stackoverflow.com/questions/64348121/error-objects-of-type-ts-not-supported-by-autoplot-cannot-knit-rmarkdown-pack
# For example, I cannot use 'autoplot()' function for such data
# Hence, I will use fpp2 for this assignment
library(ggthemes) # for beautiful themes
# library(tinytex) # for pdf documents
# library(highcharter) # for beautiful charts
library(TSA) # for TS analysis
# library(readxl) # for xls files
library(kableExtra) # for beautiful tables
library(lubridate) # for time data
library(tsibble) # for tsiblle data format
# library(plotly) # for interactive charts
library(caret) # for modeling

# Set a theme
theme_set(theme_minimal())

# Remove scientific notation 
options(scipen = 999)
``` 

### ARIMA modelling procedure

When fitting an ARIMA model to a set of (non-seasonal) time series data, the following procedure provides a useful general approach.

- Plot the data and identify any unusual observations.

- If necessary, transform the data (using a Box-Cox transformation) to stabilise the variance.

- If the data are non-stationary, take first differences of the data until the data are stationary.

- Examine the ACF/PACF

- Try your chosen model(s), and use the AICc to search for a better model.

- Check the residuals from your chosen model by plotting the ACF of the residuals, and doing a portmanteau test of the residuals. If they do not look like white noise, try a modified model.

- Once the residuals look like white noise, calculate forecasts.

<center>
![](Images/Process.png)
</center>


### Import data

```{r, message = FALSE, warning = FALSE}
# Read data
sales <- read_csv("Metro_median_sale_price_raw_week.csv")

# Check dimensions
dim(sales)
```

#### Select Chicago data

```{r, message = FALSE, warning = FALSE}
# Read data
chicago_sales <- sales %>% filter(RegionName == "Chicago, IL")

# Check dimensions
dim(chicago_sales)
```

#### Preprocess data

```{r, message = FALSE, warning = FALSE}
# Convert data from wide to long format for proper analysis
chicago_sales <- chicago_sales %>% 
                 gather(key = "Date", value = "Price", -RegionID:-StateName) %>%
                 select(RegionName, Date, Price) %>%
                 rename(Metro_area = RegionName, Median_price = Price)

# Check dimensions
dim(chicago_sales)

# Print
kable(head(chicago_sales, n = 5)) %>% kable_styling() 
```

```{r, message = FALSE, warning = FALSE}
# Convert date from character to date
chicago_sales$Date <- ymd(chicago_sales$Date)

# Print
kable(head(chicago_sales, n = 5)) %>% kable_styling() 
```

```{r, message = FALSE, warning = FALSE}
# Convert to tsibble object for time series analysis
chicago_sales <- as_tsibble(chicago_sales, key = Metro_area, index = Date)

# Check dataframe class
class(chicago_sales)
```

#### Plot data

```{r, message = FALSE, warning = FALSE}
# Plot the initial data
chicago_sales %>% autoplot(Median_price, color = "#1277e1", size = 1) +
                  labs(title = "Median Sale Price in Chicago Metro Area", subtitle = "February 2008 - August 2020") +
                  xlab("Weekly data by year") + ylab("Median Sale Price")
```

#### Brief analysis

What can we see here?

- Visually data is non-stationary

- Two trends - downwarding and upwarding

- Seasonality exists

- The seasonal fluctuation of the line slightly decreases and increases in magnitude

### Plot AFC and PAFC

Why does `ACF` and `PACF` mean?

The function `Acf` computes (and by default plots) an estimate of the autocorrelation function of a (possibly multivariate) time series. 

Function `Pacf` computes (and by default plots) an estimate of the partial autocorrelation function of a (possibly multivariate) time series.^[Hyndman, R.J., (Partial) Autocorrelation and Cross-Correlation Function Estimation. Source: https://pkg.robjhyndman.com/forecast/reference/Acf.html]

```{r, message = FALSE, warning = FALSE}
# Plot ACF 
ggAcf(chicago_sales$Median_price, color = "#1277e1", size = 1, lag = 200) + 
      labs(title = "ACF plot for Median Sale Price in Chicago Metro Area", subtitle = "February 2008 - August 2020")
```

We definitely can see a very strong autocorrelation here. 

```{r, message = FALSE, warning = FALSE}
# Plot PACF 
ggPacf(chicago_sales$Median_price, color = "#1277e1", size = 1, lag = 200) + 
       labs(title = "PACF plot for Median Sale Price in Chicago Metro Area", subtitle = "February 2008 - August 2020")
```

#### KPSS test

what is KPSS and why do we need it?

One way to determine more objectively whether differencing is required is to use a **unit root test**. These are statistical hypothesis tests of stationarity that are designed for determining whether differencing is required.

A number of unit root tests are available, which are based on different assumptions and may lead to conflicting answers. In our analysis, we use the **Kwiatkowski-Phillips-Schmidt-Shin (KPSS) test**. 

In this test, **the null hypothesis is that the data is stationary**, and we look for evidence that the null hypothesis is false.^[Hyndman, R.J., & Athanasopoulos, G. (2019) Forecasting: principles and practice, 3rd edition, OTexts: Melbourne, Australia. OTexts.com/fpp3.]

```{r, message = FALSE, warning = FALSE}
# Run the test
kpss.test(chicago_sales$Median_price)
```

For this test, we do NOT want to reject the null hypothesis. In other words, we want the p-value to be greater than 0.05 not less than 0.05.^[0.05 will be the threshold of this project]. 

**KPSS demonstrates us: our p-value is small - 0.01. Hence, our data is non-stationary.**

#### Augmented Dickey-Fuller Test

It is one of statistical tests to determine the required order of differencing. Null hypothesis is that the data are non-stationary and non-seasonal.^[Hyndman, R.J., Forecasting: Principles & Practice. Source: https://robjhyndman.com/uwafiles/fpp-notes.pdf]

```{r, message = FALSE, warning = FALSE}
# Run ADF test
adf.test(chicago_sales$Median_price)
```

We want to REJECT the null hypothesis for this test, so we want a p-value of less that 0.05 (or smaller). Here the p-value is slightly above 0.05, but still we can consider it non-stationary. 

### Box-Cox transformation

First, what is the **Box-Cox transformation** and why do we use it? 

If the data show variation that increases or decreases with the level of the series, then a transformation can be useful. 

A useful family of transformations, that includes both logarithms and power transformations, is the family of Box-Cox transformations, which depend on the parameter λ and are defined as follows:

<center>
![](Images/boxcox.png)
</center>

We can see that our data has an upwarding trend. Hence, we need to apply the transformation and stabilize the variance. 

The `BoxCox.lambda()` function will choose a value of lambda for you.^[Hyndman, R.J., & Athanasopoulos, G. (2019) Forecasting: principles and practice, 3rd edition, OTexts: Melbourne, Australia. OTexts.com/fpp3. Accessed on October 18, 2020.]

A good value of λ is one which makes the size of the seasonal variation about the same across the whole series, as that makes the forecasting model simpler. 

```{r, message = FALSE, warning = FALSE}
# Check lambda
BoxCox.lambda(chicago_sales$Median_price)
```

```{r, message = FALSE, warning = FALSE}
# Apply Box-Cox transformation
chicago_sales_bc <- chicago_sales %>% mutate(Median_price_bc = BoxCox(Median_price, BoxCox.lambda(Median_price)))

# Print
kable(head(chicago_sales_bc, n = 5)) %>% kable_styling() 
```

#### Plot Box-Cox data

```{r, message = FALSE, warning = FALSE}
# Plot BC data
chicago_sales_bc %>% autoplot(Median_price_bc, color = "#1277e1", size = 1) +
                     labs(title = "Median Sale Price (Box-Cox transformed) in Chicago Metro Area", 
                     subtitle = "February 2008 - August 2020") +
                     xlab("Weekly data by year") + ylab("Median Sale Price")
```

What can we see here?

- Our lambda is very high - almost 1.5
- Our seasonal trend remains strong

#### Plot ACF and PACF

```{r, message = FALSE, warning = FALSE}
# Plot ACF 
ggAcf(chicago_sales_bc$Median_price_bc, color = "#1277e1", size = 1, lag = 200) + 
      labs(title = "ACF plot for Median Sale Price (Box-Cox transformed) in Chicago Metro Area", 
           subtitle = "February 2008 - August 2020")
```

```{r, message = FALSE, warning = FALSE}
# Plot PACF 
ggPacf(chicago_sales_bc$Median_price_bc, color = "#1277e1", size = 1, lag = 200) + 
      labs(title = "PACF plot for Median Sale Price (Box-Cox transformed) in Chicago Metro Area", 
           subtitle = "February 2008 - August 2020")
```

Here we have the same situation - `ACF` and `PACF`demonstrate the same patterns visually. 

#### KPSS and ADF test for B-C data

```{r, message = FALSE, warning = FALSE}
# Run the test
kpss.test(chicago_sales_bc$Median_price_bc)
```

```{r, message = FALSE, warning = FALSE}
# Run ADF test
adf.test(chicago_sales_bc$Median_price_bc)
```

Our tests again tell us about the non-stationarity of our data (that was expected). P-values almost did not change (only increased for ADF test).

### Differencing

The next step will be differencing of our data. 

Differencing can help stabilise the mean of a time series by removing changes in the level of a time series, and therefore eliminating (or reducing) trend and seasonality.^[Hyndman, R.J., Forecasting: Principles & Practice. Source: https://otexts.com/fpp3]

#### Plot 1st order diff

```{r, message = FALSE, warning = FALSE}
# autoplot(diff(chicago_sales_bc$Median_price_bc, lag = 12, differences = 1), color = "#1277e1", size = 1) +
#                      labs(title = "Median Sale Price (BC and 1st order diff) in Chicago Metro Area", 
#                      subtitle = "February 2008 - August 2020") +
#                      xlab("Weekly data by year") + ylab("Median Sale Price")
```

#### Plot ACF and PACF

```{r, message = FALSE, warning = FALSE}
# Plot ACF 
ggAcf(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 1), color = "#1277e1", size = 1, lag = 200) + 
      labs(title = "ACF plot for Median Sale Price (BC and 1st order diff) in Chicago Metro Area", 
           subtitle = "February 2008 - August 2020")
```

```{r, message = FALSE, warning = FALSE}
# Plot PACF 
ggPacf(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 1), color = "#1277e1", size = 1, lag = 200) + 
      labs(title = "PACF plot for Median Sale Price (BC and 1st order diff) in Chicago Metro Area", 
           subtitle = "February 2008 - August 2020")
```

What can we see here?

The trend changed significantly in `ACF` and in `PACF` we got even more spikes. 

#### KPSS and ADF tests

```{r, message = FALSE, warning = FALSE}
# Run the test
kpss.test(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 1))
```

```{r, message = FALSE, warning = FALSE}
# Run ADF test
adf.test(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 1))
```

Remember that we want to REJECT the null hypothesis for this test, so we want a p-value of less that 0.05 (or smaller). Our p-value is pretty high still.

As a result, I will try the 2nd order differencing.

#### Plot 2nd order diff

```{r, message = FALSE, warning = FALSE}
# autoplot(diff(chicago_sales_bc$Median_price_bc, lag = 12, differences = 2), color = "#1277e1", size = 1) +
#                      labs(title = "Median Sale Price (BC and 2nd order diff) in Chicago Metro Area", 
#                      subtitle = "February 2008 - August 2020") +
#                      xlab("Weekly data by year") + ylab("Median Sale Price")
```

#### Plot ACF and PACF

```{r, message = FALSE, warning = FALSE}
# Plot ACF 
ggAcf(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 2), color = "#1277e1", size = 1, lag = 200) + 
      labs(title = "ACF plot for Median Sale Price (BC and 2nd order diff) in Chicago Metro Area", 
           subtitle = "February 2008 - August 2020")
```

```{r, message = FALSE, warning = FALSE}
# Plot PACF 
ggPacf(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 2), color = "#1277e1", size = 1, lag = 200) + 
      labs(title = "PACF plot for Median Sale Price (BC and 2nd order diff) in Chicago Metro Area", 
           subtitle = "February 2008 - August 2020")
```

#### KPSS and ADF tests

```{r, message = FALSE, warning = FALSE}
# Run the test
kpss.test(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 2))
```

```{r, message = FALSE, warning = FALSE}
# Run ADF test
adf.test(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 2))
```

#### Plot 3rd order diff

```{r, message = FALSE, warning = FALSE}
# autoplot(diff(chicago_sales_bc$Median_price_bc, lag = 12, differences = 2), color = "#1277e1", size = 1) +
#                      labs(title = "Median Sale Price (BC and 3rd order diff) in Chicago Metro Area", 
#                      subtitle = "February 2008 - August 2020") +
#                      xlab("Weekly data by year") + ylab("Median Sale Price")
```

#### Plot ACF and PACF

```{r, message = FALSE, warning = FALSE}
# Plot ACF 
ggAcf(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 3), color = "#1277e1", size = 1, lag = 200) + 
      labs(title = "ACF plot for Median Sale Price (BC and 3rd order diff) in Chicago Metro Area", 
           subtitle = "February 2008 - August 2020")
```

```{r, message = FALSE, warning = FALSE}
# Plot PACF 
ggPacf(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 3), color = "#1277e1", size = 1, lag = 200) + 
      labs(title = "PACF plot for Median Sale Price (BC and 3rd order diff) in Chicago Metro Area", 
           subtitle = "February 2008 - August 2020")
```

#### KPSS and ADF tests

```{r, message = FALSE, warning = FALSE}
# Run the test
kpss.test(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 3))
```

```{r, message = FALSE, warning = FALSE}
# Run ADF test
adf.test(diff(chicago_sales_bc$Median_price_bc, lag = 52, differences = 3))
```

We can see that visually our data still look bad, but our data according to `KPSS test` and `ADF test` now formally look stationary. For KPSS the p-value is above 0.05 and for ADF test it is below 0.05. We never had these numbers before. 








<font color='red'>Problems/Next steps: 

- If we get stationary data at a certain stage - start from `auto.arima()` and maybe some manual models (using EACF) 

- Check residuals everywhere

- What are we doing with Sarima?

- HW (additive, multiplicative, damping for both)

</font>












