---
title: "TS Zillow Team Project (VAR model)"
author: "Oleksiy Anokhin"
date: "10/29/2020"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 5
---

### Intro

#### Packages

```{r, message = FALSE, warning = FALSE}
# Install packages
library(tidyverse) # for general analysis
library(fpp)
# library(fpp2)
library(fpp3) # for predictions 
# Important notice: the latest package here is fpp3, but it does not work well sometimes with 'ts' data. 
# https://stackoverflow.com/questions/64348121/error-objects-of-type-ts-not-supported-by-autoplot-cannot-knit-rmarkdown-pack
# For example, I cannot use 'autoplot()' function for such data
# Hence, I will use fpp2 for this assignment
library(ggthemes) # for beautiful themes
# library(tinytex) # for pdf documents
# library(highcharter) # for beautiful charts
library(TSA) # for TS analysis
# library(readxl) # for xls files
library(kableExtra) # for beautiful tables
library(lubridate) # for time data
library(tsibble) # for tsiblle data format
# library(plotly) # for interactive charts
library(caret) # for modeling
library(prophet) # for TS analysis
library(lubridate)
library(zoo)
library(vars)
library(stats)

# Set a theme
theme_set(theme_minimal())

# Remove scientific notations for prices
options(scipen = 999)
``` 

### Zillow data

#### Import data

```{r, message = FALSE, warning = FALSE}
# Read data
chicago <- read_csv("Zillow monthly raw data (full).csv")

# Check dimensions
dim(chicago)
```

#### Data manipulation

```{r, message = FALSE, warning = FALSE}
# Pick Chicago only
chicago <- chicago %>% filter(RegionName == "Chicago, IL")

# Check dimensions
dim(chicago)
```

```{r, message = FALSE, warning = FALSE}
# Convert data from wide to long format for proper analysis
chicago <- chicago %>% gather(key = "Date", value = "Price", -RegionID:-StateName) %>%
                       dplyr::select(RegionName, Date, Price) %>%
                       rename(Metro_area = RegionName, Median_price = Price)
                              
# Check dimensions
dim(chicago)

# Print
kable(head(chicago, n = 5)) %>% kable_styling() 
```

```{r, message = FALSE, warning = FALSE}
# Save long data
# write.csv(chicago,"Chicago long.csv")
```

The `ds` column should be `YYYY-MM-DD` for a date, or `YYYY-MM-DD HH:MM:SS` for a `timestamp`. 

```{r, message = FALSE, warning = FALSE}
# Convert date from character to date
chicago$Date <- mdy(chicago$Date)

# Print
kable(head(chicago, n = 5)) %>% kable_styling() 
```

```{r, message = FALSE, warning = FALSE}
# Drop Metro area column
chicago <- chicago %>% dplyr::select(Date, Median_price) 

# Print
kable(head(chicago, n = 5)) %>% kable_styling() 
```

#### Plot data

```{r, message = FALSE, warning = FALSE}
# Convert to tsibble
chicago <- as_tsibble(chicago)

# Plot data
chicago %>% autoplot(Median_price, color = "#1277e1", size = 1) +
                     labs(title = "Median Sale Price in Chicago Metro Area", subtitle = "February 2008 - August 2020") +
                     xlab("Monthly data by year") + ylab("Median Sale Price")
```

### Mortgage data

#### Import data

Here we need to import data, which is report by the start of each month.

Our average mortgage interest rate in the US ire reported on weekly basis, so we need to do additional manipulations. 

```{r, message = FALSE, warning = FALSE}
# Read data
mortgage_data <- read_csv("30-Year Fixed Rate Mortgage Average (Fed).csv")

# Print
kable(head(mortgage_data, n = 5)) %>% kable_styling() 
```

#### Data manipulation

```{r, message = FALSE, warning = FALSE}
# Rename columns
mortgage_data <- mortgage_data %>% rename(Date = DATE, Rate = MORTGAGE30US)

# Print
kable(head(mortgage_data, n = 5)) %>% kable_styling() 
```

```{r, message = FALSE, warning = FALSE}
# Convert date from character to date
mortgage_data$Date <- mdy(mortgage_data$Date)

# Check class 
class(mortgage_data)
```

```{r, message = FALSE, warning = FALSE}
# Convert dataframe to tsibble
mortgage_data <- as_tsibble(mortgage_data)
```

#### Plot data

```{r, message = FALSE, warning = FALSE}
# Plot the initial data
mortgage_data %>% autoplot(Rate, color = "#1277e1", size = 1) +
                  labs(title = "30-Year Fixed US Mortgage Average Rate", subtitle = "February 2008 - August 2020") +
                  xlab("Weekly data") + ylab("Mortgage rate")
```

#### Group by month

```{r, message = FALSE, warning = FALSE}
# Read the data again
mortgage_data_monthly <- read_csv("30-Year Fixed Rate Mortgage Average (Fed).csv")

# Convert data to months
mortgage_data_monthly <- mortgage_data_monthly %>% group_by(Month = as.Date(as.yearmon(mdy(DATE)), 1)) %>% 
                                                   summarise(Average_rate = mean(MORTGAGE30US))

# Round data
mortgage_data_monthly$Average_rate <- round(mortgage_data_monthly$Average_rate, digits = 2)
                                                  
# Print
kable(head(mortgage_data_monthly, n = 5)) %>% kable_styling()
```

#### Plot data

```{r, message = FALSE, warning = FALSE}
# Convert dataframe to tsibble
mortgage_data_monthly <- as_tsibble(mortgage_data_monthly)

# # Plot the initial data
mortgage_data_monthly %>% autoplot(Average_rate, color = "#1277e1", size = 1) +
                          labs(title = "30-Year Fixed US Mortgage Average Monthly Rate", subtitle = "February 2008 - August 2020") +
                          xlab("Monthly data") + ylab("Mortgage rate")
```

```{r, message = FALSE, warning = FALSE}
# Create a new dataframe
mortgage <- cbind(chicago, mortgage_data_monthly$Average_rate)

# Check dimensions
dim(mortgage)

# Rename
# mortgage <- mortgage %>% rename(Monthly_rate = Average_rate)
names(mortgage)[names(mortgage) == "mortgage_data_monthly$Average_rate"] <- "Average_rate"

# Print
kable(head(mortgage, n = 5)) %>% kable_styling() 
```

### Stationarity

#### ACF

```{r, message = FALSE, warning = FALSE}
# Check autocorrelation
ggAcf(chicago$Median_price)
```

```{r, message = FALSE, warning = FALSE}
# Check autocorrelation
ggAcf(mortgage_data_monthly$Average_rate)
```

```{r, message = FALSE, warning = FALSE}
# Check autocorrelation
ggAcf(log(chicago$Median_price))
```

```{r, message = FALSE, warning = FALSE}
# Check autocorrelation
ggAcf(log(mortgage_data_monthly$Average_rate))
```

As we can see, we have a strong autocorrelation in both cases - with initial and log data. 

### Differencing

#### 1st order differencing 

```{r, message = FALSE, warning = FALSE}
# 1st order for Median price
Median_price_diff1 <- diff(chicago$Median_price, differences = 1)

# ACF
ggAcf(Median_price_diff1)
```

```{r, message = FALSE, warning = FALSE}
# 1st order for Average rate
Average_rate_diff1 <- diff(mortgage_data_monthly$Average_rate, differences = 1)

# ACF
ggAcf(Average_rate_diff1)
```

After a first level differencing our median price data keeps a seasonal trend, but the average rate data looks better. 

#### Tests for 1st order diff

![](https://i.ibb.co/hK2j5FP/image.png)

```{r, message = FALSE, warning = FALSE}
kpss.test(Median_price_diff1)
```

```{r, message = FALSE, warning = FALSE}
kpss.test(Average_rate_diff1)
```

```{r, message = FALSE, warning = FALSE}
adf.test(Median_price_diff1)
```

```{r, message = FALSE, warning = FALSE}
adf.test(Average_rate_diff1)
```

**According to our test results and the slide (106) by professor Abado, both variables are stationary.** 

```{r, message = FALSE, warning = FALSE}
length(chicago$Median_price)
length(Median_price_diff1)
```

#### 2nd order differencing

```{r, message = FALSE, warning = FALSE}
# 2nd order for Median price
Median_price_diff2 <- diff(chicago$Median_price, differences = 2)

# ACF
ggAcf(Median_price_diff2)
```

```{r, message = FALSE, warning = FALSE}
# 2nd order for Average rate
Average_rate_diff2 <- diff(mortgage_data_monthly$Average_rate, differences = 2)

# ACF
ggAcf(Average_rate_diff2)
```

### Plot logs vs non-logs

```{r, message = FALSE, warning = FALSE}
# Check class
class(mortgage)

# Plot the correlation
ggplot(mortgage, aes(Median_price, Average_rate)) +
       geom_point(color = "maroon") +
       geom_smooth(method = "lm", color = "darkgreen") +
       labs(title = "Correlation of Median Sales Price and monthly average US mortgage rate",
              subtitle = "February 2008 - August 2020") +
       xlab("Median Sales Price") + ylab("Average mortgage rate")

```

```{r, message = FALSE, warning = FALSE}
# Plot the correlation
ggplot(mortgage, aes(log(Median_price), log(Average_rate))) +
       geom_point(color = "maroon") +
       geom_smooth(method = "lm", color = "darkgreen") +
       labs(title = "Correlation of log Median sales price and log monthly average US mortgage rate",
              subtitle = "February 2008 - August 2020") +
       xlab("Median Sales Price") + ylab("Average mortgage rate")

```

#### Plot log monthly mortgage data

```{r, message = FALSE, warning = FALSE}
# # Plot the initial data
mortgage_data_monthly %>% autoplot(log(Average_rate), color = "#1277e1", size = 1) +
                          labs(title = "30-Year Fixed US Mortgage Average Monthly Rate (log)", subtitle = "February 2008 - August 2020") +
                          xlab("Monthly data") + ylab("log(Mortgage rate)")
```

```{r, message = FALSE, warning = FALSE}
# # Plot the initial data
chicago %>% autoplot(log(Median_price), color = "#1277e1", size = 1) +
                         labs(title = "Median Sale Price in Chicago Metro Area (log)", subtitle = "February 2008 - August 2020") +
                         xlab("Monthly data") + ylab("log(Median sale price)")
```

### VAR model

#### VAR modelling with `ts()`

```{r, message = FALSE, warning = FALSE}
# Define Median_price as ts
Median_price_ts <- ts(chicago$Median_price, start = c(2008, 2), end = c(2020, 8), frequency = 12)

# Class
class(Median_price_ts)

# Print
print(Median_price_ts)
```

```{r, message = FALSE, warning = FALSE}
# Define Average_rate as ts
Average_rate_ts <- ts(mortgage_data_monthly$Average_rate, start = c(2008, 2), end = c(2020, 8), frequency = 12)

# Print
class(Average_rate_ts)

# Print
print(Average_rate_ts)
```

```{r, message = FALSE, warning = FALSE}
# Use Var select
var_df_ts <- VARselect(cbind(Median_price_ts, Average_rate_ts))

# Print
var_df_ts

# Class
class(var_df_ts)
```

```{r, message = FALSE, warning = FALSE}
# Define a VAR(10) model ts
class(Median_price_ts)
class(Average_rate_ts)

# Cbind
var_df_ts <- cbind(Median_price_ts, Average_rate_ts) 

# Class
class(var_df_ts)
```

```{r, message = FALSE, warning = FALSE}
class(var_df_ts) <- c("mts", "ts")
class(var_df_ts)
```

```{r, message = FALSE, warning = FALSE}
# Define a VAR(10) model ts
var_10_model_ts <- VAR(var_df_ts, p = 10, type = "both", season = 12) 

# Print summary
summary(var_10_model_ts)
```

```{r, message = FALSE, warning = FALSE}
# Define a VAR(2) model ts
var_2_model_ts <- VAR(var_df_ts, p = 2, type = "both", season = 12) 

# Print summary
summary(var_2_model_ts)
```

```{r, message = FALSE, warning = FALSE}
# Fit the model VAR(10) for Median_price_ts
Median_price_ts_forecast_var_10 <- forecast(var_10_model_ts, h = 12)$forecast$Median_price_ts

# Plot the forecast
autoplot(Median_price_ts_forecast_var_10) + 
        labs(title = "VAR 10 model forecast for Median Sale Price", subtitle = "February 2008 - August 2020") +
        xlab("Monthly data") + ylab("Median Sale Price")
```

```{r, message = FALSE, warning = FALSE}
# Fit the model VAR(10) for Average_rate_ts
Average_rate_ts_forecast_var_10 <- forecast(var_10_model_ts, h = 12)$forecast$Average_rate_ts

# Plot the forecast
autoplot(Average_rate_ts_forecast_var_10) + 
        labs(title = "VAR 10 model forecast for Average Mortgage Rate", subtitle = "February 2008 - August 2020") +
        xlab("Monthly data") + ylab("Average Mortgage Rate")
```

```{r, message = FALSE, warning = FALSE}
# Fit the model VAR(2) for Median_price_ts
Median_price_ts_forecast_var_2 <- forecast(var_2_model_ts, h = 12)$forecast$Median_price_ts

# Plot the forecast
autoplot(Median_price_ts_forecast_var_2) + 
        labs(title = "VAR 2 model forecast for Median Sale Price", subtitle = "February 2008 - August 2020") +
        xlab("Monthly data") + ylab("Median Sale Price")
```

```{r, message = FALSE, warning = FALSE}
# Fit the model VAR(2) for Average_rate_ts
Average_rate_ts_forecast_var_2 <- forecast(var_2_model_ts, h = 12)$forecast$Average_rate_ts

# Plot the forecast
autoplot(Average_rate_ts_forecast_var_2) + 
        labs(title = "VAR 2 model forecast for Average Mortgage Rate", subtitle = "February 2008 - August 2020") +
        xlab("Monthly data") + ylab("Average Mortgage Rate")
```

```{r, message = FALSE, warning = FALSE}
# Check residuals for model VAr(10) for Median_price_ts
checkresiduals(var_10_model_ts$varresult$Median_price_ts, test = "LB", color = "maroon")
```


```{r, message = FALSE, warning = FALSE}
# Check residuals for model VAr(10) for Average_rate_ts
checkresiduals(var_10_model_ts$varresult$Average_rate_ts, test = "LB", color = "maroon")
```

```{r, message = FALSE, warning = FALSE}
# Check residuals for model VAr(2) for Median_price_ts
checkresiduals(var_2_model_ts$varresult$Median_price_ts, test = "LB", color = "maroon")
```

```{r, message = FALSE, warning = FALSE}
# Check residuals for model VAr(2) for Average_rate_ts
checkresiduals(var_2_model_ts$varresult$Average_rate_ts, test = "LB", color = "maroon")
```

























#### Log variables 

```{r, message = FALSE, warning = FALSE}
# Create log variables
Median_price_ts_log <- log(Median_price_ts)
Average_rate_ts_log <- log(Average_rate_ts)

# Print
head(Median_price_ts_log)
head(Average_rate_ts_log)
```

```{r, message = FALSE, warning = FALSE}
# Use Var select
var_df_ts_log <- VARselect(cbind(Median_price_ts_log, Average_rate_ts_log))

# Print
var_df_ts_log
```

```{r, message = FALSE, warning = FALSE}
# Define a VAR(10) model ts
var_10_model_ts_log <- VAR(cbind(Median_price_ts_log, Average_rate_ts_log), p = 10, type = "both", season = 12) 

# Print summary
summary(var_10_model_ts_log)
```

```{r, message = FALSE, warning = FALSE}
# Define a VAR(2) model ts
var_2_model_ts_log <- VAR(cbind(Median_price_ts_log, Average_rate_ts_log), p = 2, type = "both", season = 12) 

# Print summary
summary(var_2_model_ts_log)
```

```{r, message = FALSE, warning = FALSE}
# Check residuals for VAR(10) log model
ggAcf(residuals(var_10_model_ts_log)[, 1])
```

```{r, message = FALSE, warning = FALSE}
# Check residuals for VAR(10) log model
ggAcf(residuals(var_2_model_ts_log)[, 1])
```

### Useful resources

- [StackOverflow - VAR methodology](https://stats.stackexchange.com/questions/191851/var-forecasting-methodology/195477#195477)

- [Introduction to Econometrics with R - Vector Autoregressions](https://www.econometrics-with-r.org/16-1-vector-autoregressions.html)

- [Forecasting: Principles and Practice](https://otexts.com/fpp3/VAR.html)

- [Penn State - Vector Autoregressive models VAR(p) models](https://online.stat.psu.edu/stat510/lesson/11/11.2)

- [VAR model tutorial](https://rpubs.com/bostonchopsticks/405570)

- [Presentation](http://www.ams.sunysb.edu/~zhu/ams586/VAR_Lecture2.pdf)














